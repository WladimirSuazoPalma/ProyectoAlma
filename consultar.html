<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>Citas Activas</title>
</head>
<body>
<?php

require_once("conexionsql.php");

$usuarioID = 1; 

$conn = conectar();

if ($conn === false) {
    echo '<tr><td colspan="6" style="text-align:center; color:red;">Fallo: No se pudo establecer la conexi√≥n a la base de datos.</td></tr>';
    exit();
}

$params = array(
    array($usuarioID, SQLSRV_PARAM_IN)
);

$stmt = sqlsrv_query($conn, '{CALL CONSULTARCITASACTIVAS(?)}', $params);

if ($stmt === false) {
    echo '<tr><td colspan="6" style="text-align:center; color:red;">Error al ejecutar el procedimiento de consulta.</td></tr>';
} else {
    if (sqlsrv_has_rows($stmt)) {
        
        while ($row = sqlsrv_fetch_array($stmt, SQLSRV_FETCH_ASSOC)) {
            
            $fecha = $row['FechaCita']->format('Y-m-d');
            $hora = $row['HoraCita']->format('H:i'); 
            
            echo '<tr>';
            echo '<td>' . htmlspecialchars($row['CitaID']) . '</td>';
            echo '<td>' . htmlspecialchars($fecha) . '</td>';
            echo '<td>' . htmlspecialchars($hora) . '</td>';
            echo '<td>' . htmlspecialchars($row['NombreServicio']) . '</td>'; 
            echo '<td>' . htmlspecialchars($row['Estado']) . '</td>';
            echo '<td>';
            
            if ($row['Estado'] === 'Pendiente' || $row['Estado'] === 'Confirmada') {
                echo '<button class="boton-accion boton-cancelar" data-cita-id="' . htmlspecialchars($row['CitaID']) . '">Cancelar</button>';
            } else {
                echo 'N/A';
            }
            
            echo '</td>';
            echo '</tr>';
        }
    } else {
        echo '<tr><td colspan="6" style="text-align:center;">No tienes citas activas pendientes.</td></tr>';
    }
}


if (isset($stmt)) {
    sqlsrv_free_stmt($stmt);
}
sqlsrv_close($conn); 
?>
</body>
</html>